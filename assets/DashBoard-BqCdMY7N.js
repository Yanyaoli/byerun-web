import{b as Se,i as te}from"./request-CtygJrjG.js";import{a as F}from"./address-w6vdAG-M.js";import{k as De,l as Me,d as _,j as ne,r as o,o as v,c as T,b as e,w as t,a as u,m as oe,_ as ae,E as f,F as ee,u as xe,f as I,n as z,e as b,h as g,t as U,p as Ve}from"./index-C8NV8vGo.js";import{g as se,a as Ae,s as Le,b as Be}from"./run-CM8CnPLm.js";function Ue(){const s=async()=>{try{const n=await Se.get(F.noticeURL);if(n.status!==200)return null;const a=n.data.title,i=n.data.message,c=n.data.type;return i?{title:a,message:i,type:c}:null}catch(n){return console.error("获取通知出错：",n),null}};return{fetchNotice:s,getNotice:async()=>{try{const n=await s();if(n)De({title:n.title,message:n.message,...n.type?{type:n.type}:{},duration:5e3,dangerouslyUseHTMLString:!0,position:"top-right"});else return}catch{return}}}}const Te={key:0,class:"notice-container"},$e=["innerHTML"],je=Me({__name:"Notice",setup(s){const{fetchNotice:r}=Ue(),n=_(null);return ne(async()=>{n.value=await r()}),(a,i)=>{const c=o("el-alert");return n.value?(v(),T("div",Te,[e(c,{title:n.value.title,type:n.value.type},{default:t(()=>[u("div",{innerHTML:n.value.message,class:"notice-message"},null,8,$e)]),_:1},8,["title","type"])])):oe("",!0)}}}),He=ae(je,[["__scopeId","data-v-16b9b8e5"]]),Pe=()=>te.get(F.user),Ee=(s,r)=>te.get(F.activity,{params:{schoolId:s,studentId:r}});function Je(){const s=_(null),r=_(!1);return{user:s,userLoading:r,fetchUser:async()=>{r.value=!0,s.value=null;try{const a=await Pe();if(a.data.code===1e4){s.value=a.data.response;const i=a.data.response.oauthToken.token,c=a.data.response;return localStorage.setItem("token",i),localStorage.setItem("userData",JSON.stringify(c)),!0}else return s.value=null,f.error("获取用户信息失败: "+a.data.msg),!1}catch(a){return s.value=null,f.error("获取用户信息出错: "+a.message),!1}finally{r.value=!1}}}}function Ye(){const s=_(null),r=_(!1),n=i=>i>100?100:i;return{activity:s,isLoading:r,fetchActivity:async(i,c)=>{r.value=!0,s.value=null;try{const m=await Ee(i,c);if(m.data.code===1e4){const d=m.data.response.totalNum,y=m.data.response.joinNum,h=m.data.response.runTotalNum,k=m.data.response.runJoinNum,C=`${y}/${d}`,N=`${k}/${h}`;let D=d===0?0:Math.floor(y/d*100),M=h===0?0:Math.floor(k/h*100);D=n(D),M=n(M),s.value={club_completion_rate:C,running_completion_rate:N,club_completion_percentage:D,running_completion_percentage:M}}else f.error("获取活动信息失败: "+m.data.msg)}catch(m){f.error("获取活动信息出错: "+m.message)}finally{r.value=!1}}}}function ze(){const s=_(null),r=a=>a>100?100:a;return{runInfo:s,fetchRunInfo:async(a,i)=>{s.value=null;try{const c=await se(i);if(c.data.code!==1e4)return f.error("获取标准信息失败: "+c.data.msg),!1;const m=c.data.response.semesterYear,d=c.data.response.girlAllRunDistance,y=await Ae(a,m);if(y.data.code===1e4){const h=y.data.response.runValidDistance,k=`${h}/${d}`;let C=d===0||h===0?0:Math.floor(h/d*100);C=r(C),s.value={...y.data.response,needRunDistance:d,runDistanceCompletionRate:k,runDistanceCompletionPercentage:C}}else f.error(y.data.msg)}catch{f.error("获取跑步信息失败")}}}}function Fe(){const s=_(!1);return{isSubmitting:s,submit:async(n,a,i,c,m)=>{s.value=!0;try{const d=await se(c);if(d.data.code!==1e4)return f.error("获取学年学期失败: "+d.data.msg),!1;const y=d.data.response.semesterYear,k=await Le({runDistance:n,runTime:a,mapChoice:i,userId:m,semesterYear:y});return k.data.code!==1e4?(f.error("提交失败: "+k.data.msg),!1):(f.success("提交成功,"+k.data.response.resultDesc),!0)}catch(d){return f.error("提交失败: "+d.message),!1}finally{s.value=!1}}}}const Oe={class:"header-container"},qe={class:"left-menu"},Ge={class:"right-menu"},Ke={key:0,class:"stuInfo"},Qe={key:1,class:"stuInfo"},We={class:"runInfo"},Xe={class:"input-group"},Ze={class:"input-group"},et={class:"input-group"},tt={__name:"DashBoard",setup(s){const{user:r,fetchUser:n}=Je(),{activity:a,fetchActivity:i}=Ye(),{runInfo:c,fetchRunInfo:m}=ze(),{isSubmitting:d,submit:y}=Fe(),h=JSON.parse(localStorage.getItem("userData"))||null,k=localStorage.getItem("token")||null,C=_(!0),N=_(!0),D=()=>{x.push("/")},M=()=>{x.push("/run/record")},x=xe(),V=_(null),A=_(null),L=_(null),O=_(!0),$=_([]),P=async()=>{await i(r.value.schoolId,r.value.studentId)},q=async()=>{await m(r.value.userId,r.value.schoolId)},j=_(!1),E=async()=>{j.value=!0,await Promise.all([P(),q()]),j.value=!1},le=async()=>{if(!V.value||!A.value||!L.value){f.error("参数不完整，请检查后重新提交");return}const J=h.schoolId,l=h.userId,Y=L.value;await y(V.value,A.value,Y,J,l)&&E()},re=()=>{x.push("/club")},ue=()=>{V.value=Math.floor(Math.random()*5001)+1e3,A.value=Math.floor(Math.random()*71)+30,L.value=$.value[Math.floor(Math.random()*$.value.length)].value},ce=()=>{f.info("还没有实现该功能")};ne(async()=>{!h||!k?x.push("/home"):await n()&&(O.value=!1,E()),$.value=Be()});const ie=()=>{localStorage.clear(),x.push("/login"),f.info("账号已退出")},G=()=>{N.value=!N.value};return(J,l)=>{const Y=o("Menu"),p=o("el-icon"),H=o("el-button"),de=o("House"),R=o("el-dropdown-item"),pe=o("Basketball"),_e=o("List"),K=o("el-dropdown-menu"),Q=o("el-dropdown"),me=o("Avatar"),fe=o("Refresh"),ge=o("Switch"),W=o("el-tooltip"),ve=o("CloseBold"),he=o("el-header"),B=o("Loading"),S=o("el-progress"),ye=o("el-card"),ke=o("el-col"),we=o("el-row"),X=o("el-divider"),Z=o("el-input-number"),be=o("el-option"),Ce=o("el-select"),Ie=o("RefreshRight"),Ne=o("el-main"),Re=o("el-container");return v(),T(ee,null,[e(He),e(Re,null,{default:t(()=>[e(he,null,{default:t(()=>[u("div",Oe,[u("div",qe,[e(Q,{trigger:"click"},{dropdown:t(()=>[e(K,null,{default:t(()=>[e(R,{onClick:D},{default:t(()=>[e(p,null,{default:t(()=>[e(de)]),_:1}),l[3]||(l[3]=I(" 主页 "))]),_:1}),e(R,{onClick:re},{default:t(()=>[e(p,null,{default:t(()=>[e(pe)]),_:1}),l[4]||(l[4]=I(" 俱乐部 "))]),_:1}),e(R,{onClick:M},{default:t(()=>[e(p,null,{default:t(()=>[e(_e)]),_:1}),l[5]||(l[5]=I(" 跑步记录 "))]),_:1})]),_:1})]),default:t(()=>[e(H,{plain:"",class:"icon-button"},{default:t(()=>[e(p,null,{default:t(()=>[e(Y)]),_:1})]),_:1})]),_:1})]),l[9]||(l[9]=u("div",{class:"center-content"},[u("h2")],-1)),u("div",Ge,[e(Q,{trigger:"click"},{dropdown:t(()=>[e(K,null,{default:t(()=>[e(R,{onClick:E,disabled:j.value},{default:t(()=>[e(p,{class:z({"is-loading":j.value})},{default:t(()=>[e(fe)]),_:1},8,["class"]),l[6]||(l[6]=I(" 刷新 "))]),_:1},8,["disabled"]),e(R,{onClick:ce},{default:t(()=>[e(W,{content:"切换账号",placement:"top","open-delay":"500"},{default:t(()=>[e(p,null,{default:t(()=>[e(ge)]),_:1})]),_:1}),l[7]||(l[7]=I(" 切换 "))]),_:1}),e(R,{onClick:ie},{default:t(()=>[e(W,{content:"退出账号",placement:"top","open-delay":"500"},{default:t(()=>[e(p,{color:"red"},{default:t(()=>[e(ve)]),_:1})]),_:1}),l[8]||(l[8]=I(" 退出 "))]),_:1})]),_:1})]),default:t(()=>[e(H,{plain:"",class:"icon-button"},{default:t(()=>[e(p,null,{default:t(()=>[e(me)]),_:1})]),_:1})]),_:1})])])]),_:1}),C.value?(v(),b(Ne,{key:0},{default:t(()=>[g(r)?(v(),T("div",Ke,[u("h1",{onClick:G,class:z({masked:!N.value})},U(g(r).studentName),3),u("p",{onClick:G,class:z({masked:!N.value})},U(g(r).registerCode),3)])):(v(),T("div",Qe,[u("h1",null,[e(p,{class:"is-loading"},{default:t(()=>[e(B)]),_:1})]),u("p",null,[e(p,{class:"is-loading"},{default:t(()=>[e(B)]),_:1})])])),u("div",We,[e(we,{gutter:20,justify:"center"},{default:t(()=>[e(ke,{span:24},{default:t(()=>[e(ye,{class:"no-border-card"},{default:t(()=>[g(a)?(v(),b(S,{key:0,percentage:g(a).club_completion_percentage,"stroke-width":20,"text-inside":!0,onClick:P},{default:t(()=>[u("span",null,"俱乐部完成率 "+U(g(a).club_completion_rate),1)]),_:1},8,["percentage"])):(v(),b(S,{key:1,percentage:100,"stroke-width":20,"text-inside":!0,duration:3,striped:"","striped-flow":""},{default:t(()=>[u("span",null,[e(p,{class:"is-loading"},{default:t(()=>[e(B)]),_:1})])]),_:1})),g(a)?(v(),b(S,{key:2,percentage:g(a).running_completion_percentage,"stroke-width":20,"text-inside":!0,onClick:P},{default:t(()=>[u("span",null,"校园跑完成率 "+U(g(a).running_completion_rate),1)]),_:1},8,["percentage"])):(v(),b(S,{key:3,percentage:100,"stroke-width":20,"text-inside":!0,duration:3,striped:"","striped-flow":""},{default:t(()=>[u("span",null,[e(p,{class:"is-loading"},{default:t(()=>[e(B)]),_:1})])]),_:1})),g(c)?(v(),b(S,{key:4,percentage:g(c).runDistanceCompletionPercentage,"stroke-width":20,"text-inside":!0,onClick:q},{default:t(()=>[u("span",null,"里程完成率 "+U(g(c).runDistanceCompletionRate),1)]),_:1},8,["percentage"])):(v(),b(S,{key:5,percentage:100,"stroke-width":20,"text-inside":!0,duration:3,striped:"","striped-flow":""},{default:t(()=>[u("span",null,[e(p,{class:"is-loading"},{default:t(()=>[e(B)]),_:1})])]),_:1}))]),_:1})]),_:1})]),_:1})]),e(X),u("div",null,[u("div",Xe,[e(Z,{for:"runDistance",id:"distance",modelValue:V.value,"onUpdate:modelValue":l[0]||(l[0]=w=>V.value=w),min:1e3,max:5e3,step:100,style:{width:"200px"},placeholder:"跑步里程（米）"},null,8,["modelValue"])]),u("div",Ze,[e(Z,{for:"runTime",id:"time",modelValue:A.value,"onUpdate:modelValue":l[1]||(l[1]=w=>A.value=w),min:30,max:100,step:5,style:{width:"200px"},placeholder:"跑步时长（分钟）"},null,8,["modelValue"])]),u("div",et,[e(Ce,{id:"school",modelValue:L.value,"onUpdate:modelValue":l[2]||(l[2]=w=>L.value=w),placeholder:"请选择学校"},{default:t(()=>[(v(!0),T(ee,null,Ve($.value,w=>(v(),b(be,{key:w.value,label:w.label,value:w.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),e(H,{onClick:ue,plain:"",class:"icon-button"},{default:t(()=>[e(p,{class:"is-loading"},{default:t(()=>[e(Ie)]),_:1})]),_:1})]),e(X),e(H,{type:"primary",loading:g(d),onClick:le,disabled:O.value,round:""},{default:t(()=>l[10]||(l[10]=[I("立即提交")])),_:1},8,["loading","disabled"])]),_:1})):oe("",!0)]),_:1})],64)}}},lt=ae(tt,[["__scopeId","data-v-cb309044"]]);export{lt as default};
