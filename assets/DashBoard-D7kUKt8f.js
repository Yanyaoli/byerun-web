import{b as Ve,i as oe}from"./request-PAA82owp.js";import{a as q}from"./address-w6vdAG-M.js";import{k as Ae,l as Je,d as p,i as se,r,o as h,c as L,b as e,w as t,a as d,m as le,_ as re,E as v,F as ae,u as $e,e as b,n as F,j as D,f,t as $,p as Le}from"./index-CZ6jN7u5.js";import{g as Be,s as Ue,a as je,b as He}from"./run-mLDDUUkt.js";function Pe(){const o=async()=>{try{const a=await Ve.get(q.noticeURL);if(a.status!==200)return null;const s=a.data.title,c=a.data.message,_=a.data.type;return c?{title:s,message:c,type:_}:null}catch(a){return console.error("获取通知出错：",a),null}};return{fetchNotice:o,getNotice:async()=>{try{const a=await o();if(a)Ae({title:a.title,message:a.message,...a.type?{type:a.type}:{},duration:5e3,dangerouslyUseHTMLString:!0,position:"top-right"});else return}catch{return}}}}const Ye={key:0,class:"notice-container"},Ee=["innerHTML"],ze=Je({__name:"Notice",setup(o){const{fetchNotice:n}=Pe(),a=p(null);return se(async()=>{a.value=await n()}),(s,c)=>{const _=r("el-alert");return a.value?(h(),L("div",Ye,[e(_,{title:a.value.title,type:a.value.type},{default:t(()=>[d("div",{innerHTML:a.value.message,class:"notice-message"},null,8,Ee)]),_:1},8,["title","type"])])):le("",!0)}}}),Fe=re(ze,[["__scopeId","data-v-16b9b8e5"]]),qe=()=>oe.get(q.user),Ge=(o,n)=>oe.get(q.activity,{params:{schoolId:o,studentId:n}});function Ke(){const o=p(null),n=p(!1);return{user:o,userLoading:n,fetchUser:async()=>{n.value=!0,o.value=null;try{const s=await qe();if(s.data.code===1e4){o.value=s.data.response;const c=s.data.response.oauthToken.token,_=s.data.response;return localStorage.setItem("token",c),localStorage.setItem("userData",JSON.stringify(_)),!0}else return o.value=null,v.error("获取用户信息失败: "+s.data.msg),!1}catch(s){return o.value=null,v.error("获取用户信息出错: "+s.message),!1}finally{n.value=!1}}}}function Qe(){const o=p(null),n=p(!1),a=c=>c>100?100:c;return{activity:o,isLoading:n,fetchActivity:async(c,_)=>{n.value=!0,o.value=null;try{const i=await Ge(c,_);if(i.data.code===1e4){const u=i.data.response.totalNum,g=i.data.response.joinNum,S=i.data.response.runTotalNum,y=i.data.response.runJoinNum,C=`${g}/${u}`,B=`${y}/${S}`;let R=u===0?0:Math.floor(g/u*100),x=S===0?0:Math.floor(y/S*100);R=a(R),x=a(x),o.value={club_completion_rate:C,running_completion_rate:B,club_completion_percentage:R,running_completion_percentage:x},localStorage.setItem("activityData",JSON.stringify(o.value))}else v.error("获取活动信息失败: "+i.data.msg)}catch(i){v.error("获取活动信息出错: "+i.message)}finally{n.value=!1}}}}function We(){const o=p(null),n=s=>s>100?100:s;return{runInfo:o,fetchRunInfo:async s=>{o.value=null;try{const c=JSON.parse(localStorage.getItem("runStandardData")||"{}");if(!c.semesterYear)return v.error("错误: 缺少学期年份信息"),!1;const _=c.semesterYear,i=c.girlAllRunDistance,u=await Be(s,_);if(u.data.code===1e4){const g=u.data.response.runValidDistance,S=`${g}/${i}`;let y=i===0||g===0?0:Math.floor(g/i*100);y=n(y),o.value={...u.data.response,needRunDistance:i,runDistanceCompletionRate:S,runDistanceCompletionPercentage:y},localStorage.setItem("runInfoData",JSON.stringify(o.value))}else v.error(u.data.msg)}catch{v.error("获取跑步信息失败")}}}}function Xe(){const o=p(!1);return{isSubmitting:o,submit:async(a,s,c,_,i)=>{o.value=!0;try{const u=JSON.parse(localStorage.getItem("runStandardData")||"{}");if(!u.semesterYear)return v.error("错误: 缺少学期年份信息"),!1;const g=u.semesterYear,y=await Ue({runDistance:a,runTime:s,mapChoice:c,userId:i,semesterYear:g});return y.data.code!==1e4?(v.error("提交失败: "+y.data.msg),!1):(v.success("提交成功,"+y.data.response.resultDesc),!0)}catch(u){return v.error("提交失败: "+u.message),!1}finally{o.value=!1}}}}function Ze(){const o=p(1e3),n=p(5e3),a=p(30),s=p(100),c=p(null),_=async u=>{try{const g=await je(u);g.data.code===1e4?(c.value=g.data.response,localStorage.setItem("runStandardData",JSON.stringify(c.value)),i()):v.error("获取跑步标准信息失败: "+g.data.msg)}catch{v.error("获取跑步标准信息失败")}},i=()=>{const u=JSON.parse(localStorage.getItem("runStandardData")||"{}");JSON.parse(localStorage.getItem("userData")||"{}").gender==="1"?(o.value=u.boyOnceDistanceMin,n.value=u.boyOnceDistanceMax,a.value=u.boyOnceTimeMin,s.value=u.boyOnceTimeMax,console.log("使用男生标准")):(o.value=u.girlOnceDistanceMin,n.value=u.girlOnceDistanceMax,a.value=u.girlOnceTimeMin,s.value=u.girlOnceTimeMax,console.log("使用女生标准")),console.log(`跑步里程区间: ${o.value} - ${n.value}`),console.log(`跑步时长区间: ${a.value} - ${s.value}`)};return{runDistanceMin:o,runDistanceMax:n,runTimeMin:a,runTimeMax:s,runStandardData:c,fetchRunStandard:_,setRunStandardValues:i}}const et={class:"header-container"},tt={class:"left-menu"},nt={class:"right-menu"},at={key:0,class:"stuInfo"},ot={key:1,class:"stuInfo"},st={class:"runInfo"},lt={class:"input-group"},rt={class:"input-group"},ut={class:"input-group"},ct={__name:"DashBoard",setup(o){const{user:n,fetchUser:a}=Ke(),{activity:s,fetchActivity:c}=Qe(),{runInfo:_,fetchRunInfo:i}=We(),{isSubmitting:u,submit:g}=Xe(),{runDistanceMin:S,runDistanceMax:y,runTimeMin:C,runTimeMax:B,fetchRunStandard:R,setRunStandardValues:x}=Ze(),Y=JSON.parse(localStorage.getItem("userData"))||null,ue=localStorage.getItem("token")||null,ce=p(!0),U=p(!0),ie=()=>{O.push("/")},de=()=>{O.push("/run/record")},O=$e(),T=p(null),V=p(null),A=p(null),G=p(!0),j=p([]),E=async()=>{await c(n.value.schoolId,n.value.studentId)},K=async()=>{await i(n.value.userId,n.value.schoolId)},Q=w=>new Promise(l=>setTimeout(l,w)),H=p(!1),z=async()=>{H.value=!0;try{await E(),await Q(1e3),await K()}catch{await Q(3e3),await z()}finally{H.value=!1}},pe=async()=>{if(!T.value||!V.value||!A.value){v.error("参数不完整，请检查后重新提交");return}const w=Y.schoolId,l=Y.userId,k=A.value;await g(T.value,V.value,k,w,l)&&z()},me=()=>{O.push("/club")},_e=()=>{let w,l,k;do w=Math.floor(Math.random()*(y.value-S.value+1))+S.value,l=Math.floor(Math.random()*(B.value-C.value+1))+C.value,k=l/(w/1e3);while(k<=6);T.value=w,V.value=l,A.value=j.value[Math.floor(Math.random()*j.value.length)].value},fe=()=>{v.info("还没有实现该功能")};se(async()=>{if(!Y||!ue)O.push("/home");else if(await a()){G.value=!1,localStorage.getItem("runStandardData")?x():await R(n.value.schoolId);const k=JSON.parse(localStorage.getItem("activityData")),m=JSON.parse(localStorage.getItem("runInfoData"));k?s.value=k:await c(n.value.schoolId,n.value.studentId),m?_.value=m:await i(n.value.userId,n.value.schoolId)}j.value=He()});const ge=()=>{localStorage.clear(),O.push("/login"),v.info("账号已退出")},W=()=>{U.value=!U.value};return(w,l)=>{const k=r("Menu"),m=r("el-icon"),P=r("el-button"),ve=r("House"),M=r("el-dropdown-item"),ye=r("Basketball"),he=r("List"),X=r("el-dropdown-menu"),Z=r("el-dropdown"),Se=r("Avatar"),we=r("Refresh"),ke=r("Switch"),ee=r("el-tooltip"),Ie=r("CloseBold"),De=r("el-header"),J=r("Loading"),N=r("el-progress"),be=r("el-card"),Me=r("el-col"),Ne=r("el-row"),te=r("el-divider"),ne=r("el-input-number"),Ce=r("el-option"),Re=r("el-select"),xe=r("RefreshRight"),Oe=r("el-main"),Te=r("el-container");return h(),L(ae,null,[e(Fe),e(Te,null,{default:t(()=>[e(De,null,{default:t(()=>[d("div",et,[d("div",tt,[e(Z,{trigger:"click"},{dropdown:t(()=>[e(X,null,{default:t(()=>[e(M,{onClick:ie},{default:t(()=>[e(m,null,{default:t(()=>[e(ve)]),_:1}),l[3]||(l[3]=b(" 主页 "))]),_:1}),e(M,{onClick:me},{default:t(()=>[e(m,null,{default:t(()=>[e(ye)]),_:1}),l[4]||(l[4]=b(" 俱乐部 "))]),_:1}),e(M,{onClick:de},{default:t(()=>[e(m,null,{default:t(()=>[e(he)]),_:1}),l[5]||(l[5]=b(" 跑步记录 "))]),_:1})]),_:1})]),default:t(()=>[e(P,{plain:"",class:"icon-button"},{default:t(()=>[e(m,null,{default:t(()=>[e(k)]),_:1})]),_:1})]),_:1})]),l[9]||(l[9]=d("div",{class:"center-content"},[d("h2")],-1)),d("div",nt,[e(Z,{trigger:"click"},{dropdown:t(()=>[e(X,null,{default:t(()=>[e(M,{onClick:z,disabled:H.value},{default:t(()=>[e(m,{class:F({"is-loading":H.value})},{default:t(()=>[e(we)]),_:1},8,["class"]),l[6]||(l[6]=b(" 刷新 "))]),_:1},8,["disabled"]),e(M,{onClick:fe},{default:t(()=>[e(ee,{content:"切换账号",placement:"top","open-delay":"500"},{default:t(()=>[e(m,null,{default:t(()=>[e(ke)]),_:1})]),_:1}),l[7]||(l[7]=b(" 切换 "))]),_:1}),e(M,{onClick:ge},{default:t(()=>[e(ee,{content:"退出账号",placement:"top","open-delay":"500"},{default:t(()=>[e(m,{color:"red"},{default:t(()=>[e(Ie)]),_:1})]),_:1}),l[8]||(l[8]=b(" 退出 "))]),_:1})]),_:1})]),default:t(()=>[e(P,{plain:"",class:"icon-button"},{default:t(()=>[e(m,null,{default:t(()=>[e(Se)]),_:1})]),_:1})]),_:1})])])]),_:1}),ce.value?(h(),D(Oe,{key:0},{default:t(()=>[f(n)?(h(),L("div",at,[d("h1",{onClick:W,class:F({masked:!U.value})},$(f(n).studentName),3),d("p",{onClick:W,class:F({masked:!U.value})},$(f(n).registerCode),3)])):(h(),L("div",ot,[d("h1",null,[e(m,{class:"is-loading"},{default:t(()=>[e(J)]),_:1})]),d("p",null,[e(m,{class:"is-loading"},{default:t(()=>[e(J)]),_:1})])])),d("div",st,[e(Ne,{gutter:20,justify:"center"},{default:t(()=>[e(Me,{span:24},{default:t(()=>[e(be,{class:"no-border-card"},{default:t(()=>[f(s)?(h(),D(N,{key:0,percentage:f(s).club_completion_percentage,"stroke-width":20,"text-inside":!0,onClick:E},{default:t(()=>[d("span",null,"俱乐部完成率 "+$(f(s).club_completion_rate),1)]),_:1},8,["percentage"])):(h(),D(N,{key:1,percentage:100,"stroke-width":20,"text-inside":!0,duration:3,striped:"","striped-flow":""},{default:t(()=>[d("span",null,[e(m,{class:"is-loading"},{default:t(()=>[e(J)]),_:1})])]),_:1})),f(s)?(h(),D(N,{key:2,percentage:f(s).running_completion_percentage,"stroke-width":20,"text-inside":!0,onClick:E},{default:t(()=>[d("span",null,"校园跑完成率 "+$(f(s).running_completion_rate),1)]),_:1},8,["percentage"])):(h(),D(N,{key:3,percentage:100,"stroke-width":20,"text-inside":!0,duration:3,striped:"","striped-flow":""},{default:t(()=>[d("span",null,[e(m,{class:"is-loading"},{default:t(()=>[e(J)]),_:1})])]),_:1})),f(_)?(h(),D(N,{key:4,percentage:f(_).runDistanceCompletionPercentage,"stroke-width":20,"text-inside":!0,onClick:K},{default:t(()=>[d("span",null,"里程完成率 "+$(f(_).runDistanceCompletionRate),1)]),_:1},8,["percentage"])):(h(),D(N,{key:5,percentage:100,"stroke-width":20,"text-inside":!0,duration:3,striped:"","striped-flow":""},{default:t(()=>[d("span",null,[e(m,{class:"is-loading"},{default:t(()=>[e(J)]),_:1})])]),_:1}))]),_:1})]),_:1})]),_:1})]),e(te),d("div",null,[d("div",lt,[e(ne,{for:"runDistance",id:"distance",modelValue:T.value,"onUpdate:modelValue":l[0]||(l[0]=I=>T.value=I),min:f(S),max:f(y),step:500,style:{width:"200px"},placeholder:"跑步里程（米）"},null,8,["modelValue","min","max"])]),d("div",rt,[e(ne,{for:"runTime",id:"time",modelValue:V.value,"onUpdate:modelValue":l[1]||(l[1]=I=>V.value=I),min:f(C),max:f(B),step:10,style:{width:"200px"},placeholder:"跑步时长（分钟）"},null,8,["modelValue","min","max"])]),d("div",ut,[e(Re,{id:"school",modelValue:A.value,"onUpdate:modelValue":l[2]||(l[2]=I=>A.value=I),placeholder:"请选择学校"},{default:t(()=>[(h(!0),L(ae,null,Le(j.value,I=>(h(),D(Ce,{key:I.value,label:I.label,value:I.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),e(P,{onClick:_e,plain:"",class:"icon-button"},{default:t(()=>[e(m,{class:"is-loading"},{default:t(()=>[e(xe)]),_:1})]),_:1})]),e(te),e(P,{type:"primary",loading:f(u),onClick:pe,disabled:G.value,round:""},{default:t(()=>l[10]||(l[10]=[b("立即提交")])),_:1},8,["loading","disabled"])]),_:1})):le("",!0)]),_:1})],64)}}},_t=re(ct,[["__scopeId","data-v-7110b908"]]);export{_t as default};
